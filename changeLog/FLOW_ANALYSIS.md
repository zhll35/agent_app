# ğŸ” SOP è¯Šæ–­æµç¨‹åˆ†æä¸é—®é¢˜ä¿®å¤

## ğŸ“‹ é—®é¢˜æè¿°

**ç—‡çŠ¶**ï¼šç”¨æˆ·è¾“å…¥ç”µå‹åï¼Œç³»ç»Ÿä»ç„¶è¦æ±‚è¾“å…¥ç”µå‹ï¼Œæ— æ³•è¿›å…¥ä¸‹ä¸€æ­¥

**æ ¹æœ¬åŸå› **ï¼š
1. âŒ **æ²¡æœ‰ä½¿ç”¨ Checkpoint**ï¼šçŠ¶æ€æ²¡æœ‰æŒä¹…åŒ–ï¼Œæ¯æ¬¡è¯·æ±‚éƒ½æ˜¯å…¨æ–°çŠ¶æ€
2. âŒ **YAML é…ç½®ç¼ºå°‘ prompt å­—æ®µ**ï¼šéƒ¨åˆ†æ­¥éª¤æ²¡æœ‰ `prompt`ï¼Œå¯¼è‡´è¿è¡Œæ—¶é”™è¯¯
3. âŒ **è·¯ç”±é€»è¾‘ä¸å®Œæ•´**ï¼šDiagnostician æ‰§è¡Œåæ²¡æœ‰æ­£ç¡®çš„è·¯ç”±

---

## ğŸ”„ å®Œæ•´äº¤äº’æµç¨‹

### 1ï¸âƒ£ ç”¨æˆ·é¦–æ¬¡å‘é€æ¶ˆæ¯

```
ç”¨æˆ·: "æˆ‘æƒ³è°ƒå¤§ç”µæµ"
  â†“
Server æ¥æ”¶è¯·æ±‚ (thread_id: "abc-123")
  â†“
Graph æ‰§è¡Œ (æ²¡æœ‰å†å²çŠ¶æ€)
  â†“
route_supervisor() åˆ¤æ–­
  - is_info_complete = False
  - è·¯ç”±åˆ° NODE_COLLECTOR
  â†“
collector_node() æ‰§è¡Œ
  - æ£€æŸ¥ç¼ºå¤±å­—æ®µ
  - è¿”å›: "è¯·æä¾›è½¦å‹ã€æ§åˆ¶å™¨å‹å·..."
  â†“
è¿”å›ç»™ç”¨æˆ·
```

### 2ï¸âƒ£ ç”¨æˆ·è¡¥å……ä¿¡æ¯

```
ç”¨æˆ·: "ä¹å· E100, Lingbo-72182"
  â†“
Server æ¥æ”¶è¯·æ±‚ (thread_id: "abc-123")
  â†“
Graph æ‰§è¡Œ (åŠ è½½ checkpoint çŠ¶æ€)
  â†“
route_supervisor() åˆ¤æ–­
  - is_info_complete = False (è¿˜ç¼ºå°‘ä¿¡æ¯)
  - è·¯ç”±åˆ° NODE_COLLECTOR
  â†“
collector_node() æ‰§è¡Œ
  - æ›´æ–° customer_info
  - æ£€æŸ¥æ˜¯å¦å®Œæ•´
  - is_info_complete = True
  - è¿”å›: "ä¿¡æ¯æ”¶é›†å®Œæ•´ï¼Œå¼€å§‹ä¸ºæ‚¨æ’æŸ¥..."
  â†“
route_after_collector() åˆ¤æ–­
  - is_info_complete = True
  - è·¯ç”±åˆ° NODE_DIAGNOSTICIAN
  â†“
diagnostic_agent.invoke() æ‰§è¡Œ
  - current_step = 0
  - è¾“å‡º: "è¯·ç¡®è®¤å…¨è½¦ç”µå‹æ˜¯å¤šå°‘ã€‚"
  â†“
è¿”å›ç»™ç”¨æˆ·
```

### 3ï¸âƒ£ ç”¨æˆ·å›ç­”ç¬¬ä¸€æ­¥ï¼ˆç”µå‹ï¼‰

```
ç”¨æˆ·: "72V"
  â†“
Server æ¥æ”¶è¯·æ±‚ (thread_id: "abc-123")
  â†“
Graph æ‰§è¡Œ (åŠ è½½ checkpoint çŠ¶æ€)
  - current_step = 0
  - is_info_complete = True
  â†“
route_supervisor() åˆ¤æ–­
  - is_info_complete = True
  - diagnostic_result = None
  - è·¯ç”±åˆ° NODE_DIAGNOSTICIAN
  â†“
diagnostic_agent.invoke() æ‰§è¡Œ
  - current_step = 0
  - last_message.type = "human"
  - æ ¡éªŒç”¨æˆ·è¾“å…¥ï¼ˆç®€åŒ–ï¼šå‡è®¾é€šè¿‡ï¼‰
  - next_step = 1
  - è¾“å‡º: "æ­£åœ¨ä¸ºæ‚¨æ ¸å¯¹æ§åˆ¶å™¨ä¸è½¦å‹çš„åŒ¹é…æ€§ï¼Œè¯·ç¨å€™..."
  - æ›´æ–° current_step = 1
  â†“
route_after_diagnostician() åˆ¤æ–­
  - è¿”å› "__end__"
  â†“
ä¿å­˜çŠ¶æ€åˆ° checkpoint
  â†“
è¿”å›ç»™ç”¨æˆ·
```

### 4ï¸âƒ£ ç”¨æˆ·ç»§ç»­ä¸‹ä¸€æ­¥

```
ç”¨æˆ·: "å¥½çš„"
  â†“
Server æ¥æ”¶è¯·æ±‚ (thread_id: "abc-123")
  â†“
Graph æ‰§è¡Œ (åŠ è½½ checkpoint çŠ¶æ€)
  - current_step = 1
  - is_info_complete = True
  â†“
route_supervisor() åˆ¤æ–­
  - is_info_complete = True
  - diagnostic_result = None
  - è·¯ç”±åˆ° NODE_DIAGNOSTICIAN
  â†“
diagnostic_agent.invoke() æ‰§è¡Œ
  - current_step = 1
  - last_message.type = "human"
  - next_step = 2
  - è¾“å‡º: "è¯·æ‹ä¸€å¼ è½¬æ¥çº¿æ’å¤´çš„ç…§ç‰‡..."
  - æ›´æ–° current_step = 2
  â†“
è¿”å›ç»™ç”¨æˆ·
```

---

## ğŸ› ï¸ å·²ä¿®å¤çš„é—®é¢˜

### ä¿®å¤ 1: æ·»åŠ  Checkpoint æ”¯æŒ

**æ–‡ä»¶**: `src/agent_app/graph/build.py`

```python
from langgraph.checkpoint.memory import MemorySaver

def build_graph():
    workflow = StateGraph(AgentState)
    # ... æ·»åŠ èŠ‚ç‚¹å’Œè¾¹ ...
    
    # âœ… æ·»åŠ  Checkpoint
    memory = MemorySaver()
    app = workflow.compile(checkpointer=memory)
    return app
```

**ä½œç”¨**ï¼š
- âœ… ä¿å­˜æ¯æ¬¡æ‰§è¡Œåçš„çŠ¶æ€
- âœ… ä¸‹æ¬¡è¯·æ±‚æ—¶æ¢å¤çŠ¶æ€ï¼ˆé€šè¿‡ thread_idï¼‰
- âœ… `current_step` ä¼šè¢«æŒä¹…åŒ–

### ä¿®å¤ 2: è¡¥å…… YAML ç¼ºå¤±çš„ prompt å­—æ®µ

**æ–‡ä»¶**: `src/agent_app/knowledge/templates/sop_diagnostic.yaml`

```yaml
# âŒ ä¿®å¤å‰
- id: step_2_match
  title: "æ ¸å¯¹æ§åˆ¶å™¨åŒ¹é…æ€§"
  action: "internal_lookup"
  # ç¼ºå°‘ prompt å­—æ®µï¼

# âœ… ä¿®å¤å
- id: step_2_match
  title: "æ ¸å¯¹æ§åˆ¶å™¨åŒ¹é…æ€§"
  action: "internal_lookup"
  prompt: "æ­£åœ¨ä¸ºæ‚¨æ ¸å¯¹æ§åˆ¶å™¨ä¸è½¦å‹çš„åŒ¹é…æ€§ï¼Œè¯·ç¨å€™..."
```

**ä½œç”¨**ï¼š
- âœ… é¿å…è¿è¡Œæ—¶ KeyError
- âœ… æ¯ä¸ªæ­¥éª¤éƒ½æœ‰æ˜ç¡®çš„æç¤ºä¿¡æ¯

### ä¿®å¤ 3: æ·»åŠ  Diagnostician è·¯ç”±å‡½æ•°

**æ–‡ä»¶**: `src/agent_app/graph/routing.py`

```python
def route_after_diagnostician(state: AgentState) -> Literal["__end__"]:
    """Diagnostician èŠ‚ç‚¹å®Œæˆåçš„è·¯ç”±é€»è¾‘"""
    # è¯Šæ–­æµç¨‹æ€»æ˜¯ç»“æŸï¼Œç­‰å¾…ç”¨æˆ·ä¸‹ä¸€æ¬¡è¾“å…¥
    # çŠ¶æ€ä¼šè¢«ä¿å­˜åœ¨ checkpoint ä¸­ï¼Œä¸‹æ¬¡ç»§ç»­
    return "__end__"
```

**æ–‡ä»¶**: `src/agent_app/graph/build.py`

```python
# âœ… æ·»åŠ æ¡ä»¶è¾¹
workflow.add_conditional_edges(
    NODE_DIAGNOSTICIAN,
    route_after_diagnostician,
    {
        "__end__": END
    }
)
```

**ä½œç”¨**ï¼š
- âœ… Diagnostician æ‰§è¡Œåæ­£ç¡®ç»“æŸ
- âœ… çŠ¶æ€è¢«ä¿å­˜ï¼Œç­‰å¾…ä¸‹æ¬¡è¾“å…¥

### ä¿®å¤ 4: å¢å¼ºé”™è¯¯å¤„ç†å’Œæ—¥å¿—

**æ–‡ä»¶**: `src/agent_app/agents/executor.py`

```python
# âœ… æ·»åŠ æ—¥å¿—
logger.info(f"DiagnosticAgent æ‰§è¡Œ - å½“å‰æ­¥éª¤: {current_step_idx}/{len(steps)}")

# âœ… æ£€æŸ¥ prompt å­—æ®µ
if "prompt" not in step:
    logger.error(f"æ­¥éª¤ {current_step_idx} ç¼ºå°‘ 'prompt' å­—æ®µ")
    return {
        "messages": [("assistant", "é…ç½®é”™è¯¯ï¼šæ­¥éª¤ç¼ºå°‘æç¤ºä¿¡æ¯")],
        "diagnostic_result": "error"
    }
```

**ä½œç”¨**ï¼š
- âœ… è¯¦ç»†çš„æ‰§è¡Œæ—¥å¿—
- âœ… ä¼˜é›…çš„é”™è¯¯å¤„ç†
- âœ… æ›´å®¹æ˜“è°ƒè¯•

---

## ğŸ“Š çŠ¶æ€æµè½¬å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ç”¨æˆ·å‘é€æ¶ˆæ¯                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Server æ¥æ”¶ (thread_id)                         â”‚
â”‚              åŠ è½½ Checkpoint çŠ¶æ€                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              route_supervisor()                              â”‚
â”‚              åˆ¤æ–­è·¯ç”±ç›®æ ‡                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                â”‚                â”‚
    is_info_complete?  diagnostic_result?  default
         â”‚                â”‚                â”‚
         â–¼                â–¼                â–¼
    COLLECTOR         __end__        DIAGNOSTICIAN
         â”‚                                 â”‚
         â–¼                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ collector_node  â”‚              â”‚ diagnostic_agentâ”‚
â”‚ - æ”¶é›†ä¿¡æ¯      â”‚              â”‚ - æ‰§è¡Œæ­¥éª¤      â”‚
â”‚ - æ£€æŸ¥å®Œæ•´æ€§    â”‚              â”‚ - æ›´æ–° step     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                 â”‚
         â–¼                                 â–¼
  route_after_collector()        route_after_diagnostician()
         â”‚                                 â”‚
         â–¼                                 â–¼
    DIAGNOSTICIAN                      __end__
         â”‚                                 â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ ä¿å­˜ Checkpoint â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   è¿”å›ç»™ç”¨æˆ·    â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ å…³é”®ç‚¹æ€»ç»“

### 1. Checkpoint çš„ä½œç”¨
- **ä¿å­˜çŠ¶æ€**ï¼š`current_step`, `is_info_complete`, `customer_info` ç­‰
- **æ¢å¤çŠ¶æ€**ï¼šé€šè¿‡ `thread_id` æ¢å¤ä¸Šæ¬¡çš„çŠ¶æ€
- **å¤šè½®å¯¹è¯**ï¼šæ”¯æŒåˆ†æ­¥éª¤çš„äº¤äº’æµç¨‹

### 2. è·¯ç”±é€»è¾‘
- **route_supervisor**ï¼šå…¥å£è·¯ç”±ï¼Œå†³å®šè¿›å…¥å“ªä¸ªèŠ‚ç‚¹
- **route_after_collector**ï¼šCollector å®Œæˆåçš„è·¯ç”±
- **route_after_diagnostician**ï¼šDiagnostician å®Œæˆåçš„è·¯ç”±

### 3. çŠ¶æ€å­—æ®µ
- `current_step`: å½“å‰è¯Šæ–­æ­¥éª¤ç´¢å¼•
- `is_info_complete`: ä¿¡æ¯æ˜¯å¦æ”¶é›†å®Œæ•´
- `diagnostic_result`: è¯Šæ–­ç»“æœï¼ˆcompleted/errorï¼‰
- `customer_info`: å®¢æˆ·ä¿¡æ¯
- `messages`: æ¶ˆæ¯å†å²

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### 1. å¯åŠ¨æœåŠ¡

```bash
./start_debug.sh
```

### 2. æµ‹è¯•å®Œæ•´æµç¨‹

```bash
# ç¬¬ä¸€æ¬¡è¯·æ±‚
curl -X POST http://localhost:8000/chat \
  -H "Content-Type: application/json" \
  -d '{
    "message": "æˆ‘æƒ³è°ƒå¤§ç”µæµ",
    "thread_id": "test-123",
    "mock_info": {}
  }'

# ç¬¬äºŒæ¬¡è¯·æ±‚ï¼ˆè¡¥å……ä¿¡æ¯ï¼‰
curl -X POST http://localhost:8000/chat \
  -H "Content-Type: application/json" \
  -d '{
    "message": "ä¹å· E100, Lingbo-72182",
    "thread_id": "test-123",
    "mock_info": {
      "vehicle_model": "ä¹å· E100",
      "controller_model": "Lingbo-72182"
    }
  }'

# ç¬¬ä¸‰æ¬¡è¯·æ±‚ï¼ˆå›ç­”ç”µå‹ï¼‰
curl -X POST http://localhost:8000/chat \
  -H "Content-Type: application/json" \
  -d '{
    "message": "72V",
    "thread_id": "test-123",
    "mock_info": {}
  }'
```

### 3. è§‚å¯Ÿæ—¥å¿—

```
2024-01-11 09:00:00 - INFO - æ”¶åˆ°èŠå¤©è¯·æ±‚ - Thread ID: test-123
2024-01-11 09:00:00 - INFO - DiagnosticAgent æ‰§è¡Œ - å½“å‰æ­¥éª¤: 0/5
2024-01-11 09:00:00 - INFO - ç”¨æˆ·å·²å›å¤ï¼Œå‡†å¤‡è¿›å…¥ä¸‹ä¸€æ­¥
2024-01-11 09:00:00 - INFO - è¿›å…¥ä¸‹ä¸€æ­¥: 1
2024-01-11 09:00:00 - INFO - è¾“å‡ºä¸‹ä¸€æ­¥é—®é¢˜: æ­£åœ¨ä¸ºæ‚¨æ ¸å¯¹æ§åˆ¶å™¨ä¸è½¦å‹çš„åŒ¹é…æ€§...
```

---

## âœ… ä¿®å¤éªŒè¯æ¸…å•

- [x] Checkpoint å·²æ·»åŠ ï¼ˆMemorySaverï¼‰
- [x] YAML æ‰€æœ‰æ­¥éª¤éƒ½æœ‰ prompt å­—æ®µ
- [x] route_after_diagnostician å‡½æ•°å·²æ·»åŠ 
- [x] é”™è¯¯å¤„ç†å’Œæ—¥å¿—å·²å¢å¼º
- [x] çŠ¶æ€å­—æ®µæ­£ç¡®æ›´æ–°
- [x] è·¯ç”±é€»è¾‘æ­£ç¡®

---

**ç°åœ¨ç³»ç»Ÿåº”è¯¥å¯ä»¥æ­£å¸¸å·¥ä½œäº†ï¼** ğŸ‰

